{% extends 'base.html.twig' %}

{% block title %}EntrÃ©e vos coordonnÃ©es{% endblock %}

{% block body %}
<div class="max-w-lg mx-auto mt-10 bg-white p-6 rounded-lg shadow-lg">
    <h2 class="text-2xl font-semibold text-gray-800 mb-4">ðŸ›’ Validation du panier</h2>

    {{ form_start(form, {'attr': {'id': 'billingForm', 'class': 'space-y-4'}}) }}
        <div>
            <label class="block text-sm font-medium text-gray-700">{{ form.address.vars.label }}</label>
            {{ form_widget(form.address, {'attr': {'class': 'mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500'}}) }}
        </div>

        <div>
            <label class="block text-sm font-medium text-gray-700">{{ form.city.vars.label }}</label>
            {{ form_widget(form.city, {'attr': {'class': 'mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500'}}) }}
        </div>

        <div>
            <label class="block text-sm font-medium text-gray-700">{{ form.postal_code.vars.label }}</label>
            {{ form_widget(form.postal_code, {'attr': {'class': 'mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500'}}) }}
        </div>

    {{ form_end(form) }}
</div>

<script src="https://js.stripe.com/v3/"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        document.getElementById("billingForm").addEventListener("submit", function (event) {
            event.preventDefault(); // EmpÃªche le rechargement de la page
            
            let form = new FormData(this);
            fetch("{{ path('checkout_page') }}", { 
                method: "POST",
                body: form
            })
            .then(response => response.text())
            .then(() => {
                // AprÃ¨s soumission de l'adresse, on crÃ©e la session Stripe
                return fetch("{{ path('checkout_session') }}", { method: "POST" });
            })
            .then(response => response.json())
            .then(session => {
                if (session.error) {
                    console.error("Erreur:", session.error);
                    alert("Erreur : " + session.error);
                    return;
                }
                // Redirection vers Stripe
                return Stripe("{{ stripe_public_key }}").redirectToCheckout({ sessionId: session.id });
            })
            .catch(error => console.error("Erreur lors de la validation du paiement:", error));
        });
    });
</script>

{% endblock %}
